use std::{iter::once, str::FromStr};

use aoc_traits::AdventOfCodeDay;

type Coords = (isize, isize);

#[derive(Debug)]
struct Galaxy {
    coords: Coords,
}

#[derive(Debug)]
pub struct Observation {
    galaxies: Vec<Galaxy>,
    offset_x: Vec<isize>,
    offset_y: Vec<isize>,
}

fn compute_distance(observation: &Observation, growth: isize) -> isize {
    let mut sum = 0;

    for i in 0..observation.galaxies.len() {
        for j in i + 1..observation.galaxies.len() {
            let off_x_i = observation.offset_x[observation.galaxies[i].coords.0 as usize] * growth;
            let off_x_j = observation.offset_x[observation.galaxies[j].coords.0 as usize] * growth;
            let off_y_i = observation.offset_y[observation.galaxies[i].coords.1 as usize] * growth;
            let off_y_j = observation.offset_y[observation.galaxies[j].coords.1 as usize] * growth;
            let distance = ((observation.galaxies[i].coords.0 + off_x_i)
                - (observation.galaxies[j].coords.0 + off_x_j))
                .abs()
                + ((observation.galaxies[i].coords.1 + off_y_i)
                    - (observation.galaxies[j].coords.1 + off_y_j))
                    .abs();
            sum += distance;
        }
    }
    sum
}

fn solve_part1(observation: &Observation) -> isize {
    compute_distance(observation, 1)
}

fn solve_part2(observation: &Observation) -> isize {
    compute_distance(observation, 999999)
}

impl FromStr for Observation {
    type Err = ();

    fn from_str(s: &str) -> Result<Self, Self::Err> {
        let trimed = s.trim();
        let galaxies = trimed
            .lines()
            .enumerate()
            .flat_map(|(x, line)| {
                line.trim().chars().enumerate().filter_map(move |(y, c)| {
                    if c == '#' {
                        Some(Galaxy {
                            coords: (x as isize, y as isize),
                        })
                    } else {
                        None
                    }
                })
            })
            .collect();
        let mut offset_x = vec![];
        let mut offset_y = vec![false; trimed.lines().next().unwrap().len()];
        let mut offset = 0;
        for line in trimed.lines() {
            let line = line.trim();
            if !line.contains('#') {
                offset += 1;
            }
            offset_y
                .iter_mut()
                .zip(line.chars())
                .for_each(|(offset, c)| *offset |= c == '#');
            offset_x.push(offset);
        }

        let mut offset = 0;
        Ok(Self {
            galaxies,
            offset_x,
            offset_y: offset_y
                .into_iter()
                .map(|off| {
                    if !off {
                        offset += 1
                    }
                    offset
                })
                .collect(),
        })
    }
}
pub struct Day11Solver;

impl<'a> AdventOfCodeDay<'a> for Day11Solver {
    type ParsedInput = Observation;

    type Part1Output = isize;

    type Part2Output = isize;

    fn solve_part1(input: &Self::ParsedInput) -> Self::Part1Output {
        solve_part1(input)
    }

    fn solve_part2(input: &Self::ParsedInput) -> Self::Part2Output {
        solve_part2(input)
    }

    fn parse_input(input: &'a str) -> Self::ParsedInput {
        input.parse().unwrap()
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn example_1() {
        let input = "
        ...#......
        .......#..
        #.........
        ..........
        ......#...
        .#........
        .........#
        ..........
        .......#..
        #...#.....";
        let observation = input.parse::<Observation>().unwrap();
        //assert_eq!(374, solve_part1(&observation));
        assert_eq!(999999, solve_part2(&observation));
    }

    #[test]
    fn challenge_1() {
        let input = "................................#.......#......#.....#...........................#..........................................................
        ..........................................................#..........................................................#...........#..........
        .....#.....................#.............................................................#..................................................
        .............#..............................................................................................................................
        .....................................................................................#....................#.................#...............
        ..................#..........................................#...................................#..............#...........................
        ...............................#....................................................................................................#.......
        ..........#..............#.............#................#...................#...............................................................
        ....#............................................................................#..........................................................
        ...............#................................#......................................................................#................#...
        ...................................#.............................#...............................................#..........#.....#.........
        #...................................................................................#.....#.....#......#....................................
        ...............................#............................................................................................................
        ..........................................................#................#................................................................
        .......#.......................................................................................................................#............
        ..#.........#.........................................................................#.....................................................
        ..........................................#........#.......................................#.......#..................#............#........
        .................#..............#..............................#...............................................#..........................#.
        ...............................................................................................#........#...................................
        ......................#............................................#......................................................#.................
        .....................................#.....................................#..........................................................#.....
        ......#......................#...................#......#...................................................................................
        ..........................................................................................................#.................................
        ......................................................................#.........................................#.............#.............
        #............................................#.........................................#.................................................#..
        .............................................................#.....................................#........................................
        ..............#..............................................................................................#....................#.........
        .........#.........#...................................#....................................................................................
        ........................................#..............................#........................#......#.................#..................
        ......................................................................................#................................................#....
        ................#...........#...............................................................................................................
        .....................................................#.........#............................................................................
        ....#.......#.......#.......................................................#.....................#.........................................
        .....................................#...........#..............................................................#...........................
        ..........................................................................................................#.................................
        .......................#.............................................#..........#...........................................................
        #............................................................#...........................#.................................#.......#........
        .............................#......................................................#.................................#.....................
        .........................................#............#.................#......................#..............#................#.........#..
        ............................................................................................................................................
        ..........#.................................................................................................................................
        ..........................................................#.......................................#.........................................
        #.....................#...............#..........#....................#.................................#...................#...............
        ............................................................................................................................................
        .......#..........................#.........................................................................................................
        .................#...............................................#..............................#.................................#.........
        ........................................................................................................................#...................
        ..............................#.................#.....#..............................#..........................#...........................
        .....................................#.........................................#...........................#.........................#......
        .............#.....................................................#............................................................#..........#
        ....#.........................................................#..................................#..........................................
        ............................................#...........................#..................................................#................
        ...............................#.........................................................................#..................................
        ............................................................................................................................................
        .................#.........#....................#..........................#........................................................#.......
        .......................................................#....................................#...............................................
        ............................................................................................................................................
        ...#...............................................................................#............................................#...........
        ..........#.....................#......................................................................#....................................
        .........................................#..................................................................................................
        .....................................................#.................#.............................................#..............#.......
        ......................#.......................#.............................................................................#...............
        ........#.............................#..........................#....................#.......................#.............................
        .................#..........................................................................#.....#.............................#.........#.
        ............................................................................................................................................
        .........................................................................#..................................................................
        ..............................................................#.............................................................................
        ..........................#.............#..........................#.......................................#..........#.....................
        ............................................................................................................................................
        ..............................#......................................................................#............#...............#.........
        .............#..............................#.........#.................#...................................................................
        .....................#............................................................#.......................................#.................
        ......................................#................................................#.................................................#..
        .................#...............................#..........................................................#...............................
        ........#......................................................#...........#................................................................
        .........................................#......................................#...........#.....................#.........................
        .#.........................#................................................................................................................
        ................................................................................................#...................................#......#
        ...........................................................#............#.............#..................#..................................
        ..................................................#.........................................................................................
        ...........#................................#......................#................................................#..........#............
        ........................#.........#.........................................................................................................
        .............................................................#.................................#...............#...........#................
        ................#............#.......................................................................#......................................
        .#......................................................................#......#...........#................................................
        ........................................................#..................................................#................................
        ......................#...................#.....#..................#..............................#.........................................
        ............................................................................................................................................
        ...........#..........................#....................#............................................................#...................
        ...................#...................................................................#...............................................#....
        ...........................#...................................................................#.........#..................................
        .....#...........................................#.........................................................................#................
        ......................#.............#......................................#......#.................#.......................................
        ...............#..............#...........................................................#.....................#...............#...........
        ...........................................................#.....#.........................................................................#
        .......................................#...............................#....................................................................
        .................................#..................#..................................................................................#....
        ...........................................#..................................#.........................#...................................
        .........#..............................................................................#...................................................
        ................#.....#................................#.................................................................#..................
        .................................................................................................#..........................................
        #..............................................#........................#...........................................#................#......
        ..............................#...................................................#.......................#.................................
        ..................#.................................#......................................................................................#
        ..........#................................#..................................#...........#.................................................
        .....................................................................#....................................................#.................
        ...............#.....................................................................................................#......................
        #........................................................#......#..........................................#........................#.......
        .......................#.........#......#...................................................................................................
        .....#......................................................................................................................................
        ..................#...............................#....................................................................#....................
        ............................................#......................#........................................................................
        .............#........................................#.........................#.........#........................#.....................#..
        ...................................................................................................#..............................#.........
        ..........................#.................................................................................................................
        ..#................#....................................................#.......................................#...........................
        ...........#.................................#.........................................#................................#.............#.....
        ......................................#.......................#.....#.....................................#.................................
        .................................#...............................................................#..........................................
        .................#..........#.............................................#.......#...............................#..........#..............
        .......................................................#................................................................................#...
        ..#........................................................................................#................................................
        ............................................................................................................................................
        ...................................#..........................................#.............................................................
        ...........................................#........#...............................................#...........................#...........
        ................................................................#......#....................................................................
        ....#.................#.........................#...............................................................#...........................
        ............................#..............................................................................#................#.......#.......
        ........#................................#................#.............................#............................#......................
        #....................................................#..................................................................................#...
        ............#........................................................#........................#.............................................
        ..................#................#.......................................#................................................................
        ...........................#...............#......#..........#..................#..................#.................................#.....#
        ..........................................................................................#......................#.........#................
        .......................................#....................................................................#...............................
        ...............#..............#........................................#................................................................#...
        ..........#.................................................................#...............................................................
        .....#...............................................#.....#.....................................#..................#.........#.............
        ...............................................#........................................................#...................................
        .#....................#.............................................................#.................................................#.....
        ";
        let observation = input.parse::<Observation>().unwrap();
        assert_eq!(9403026, solve_part1(&observation));
        assert_eq!(543018317006, solve_part2(&observation));
    }
}
